var DM5_DIAG_DIAG2; var DM5_ISREPLAYSHOW = false; var DM5_ISRREPORTSHOW = false; var DM5_DIAG_DIAG3; $(function () { $(".postdel").click(function () { openDiv("postdeldiv"); $("#del_pid").val($(this).attr("pid")); $("#del_tid").val($(this).attr("tid")) }); $(".btnreport").click(function () { reporttizi($(this)) }) }); function reporttizi(B) { var C = B.attr("tid"); var A = B.attr("pid"); if (!B.attr("tid")) { C = 0 } if (!B.attr("pid")) { A = 0 } if (DM5_ISRREPORTSHOW == false) { DM5_DIAG_DIAG3 = $("#reportdialog"); DM5_DIAG_DIAG3.dialog({ width: 620, draggable: false, resizable: false, autoOpen: false, modal: true, title: "举报帖子" }); $("#reportdialog").html("<p style='text-align:center;color:red;' id='reportstatus'>正在加载,请稍候...</p>"); DM5_DIAG_DIAG3.dialog("open"); $(window).scroll(function () { DM5_DIAG_DIAG3.dialog("option", "position", "center") }); $("#reportdialog").load("/reportdialog/", function () { $("#reportform").show(); $("#ttid").val(C); $("#tpid").val(A); $("#reportstatus").hide(); $("#postreportimg").attr("src", "image.ashx?action=bar?d=" + new Date()); $("#showreportmessage").text("") }); DM5_ISREPLAYSHOW = true } else { $("#reportform").show(); $("#ttid").val(C); $("#tpid").val(A); $("#reportstatus").hide(); $("#postreportimg").attr("src", "image.ashx?action=bar?d=" + new Date()); $("#showreportmessage").text(""); DM5_DIAG_DIAG3.dialog("open") } } function postreportajax() { var C = $("#ttid").val(); var A = $("#tpid").val(); var D = $("#txt_repcontent").val(); var B = $("#txt_repcode"); if (B.length > 0) { if (B.val() == "") { $("#showreportmessage").text("验证码必须填写！"); return false } if (!validcode("postreportimg", B.val(), "bar")) { $("#showreportmessage").text("验证码错误！"); return false } } if (D.length < 5) { $("#showreportmessage").text("举报理由字数不能少于5个！"); return false } if (D.length > 50) { $("#showreportmessage").text("举报理由字数不能超过于50个！"); return false } if (!(/[\u4e00-\u9fa5]/).test(D)) { $("#showreportmessage").text("举报理由必须包含中文！"); return false } $("#reportform").hide(); $("#reportstatus").text("数据正在提交！"); $("#reportstatus").show(); $.ajax({ url: "position.ashx?d=" + new Date(), dataType: "json", data: { pid: A, tid: C, reason: D, action: "report" }, error: function (E) { alert(E) }, success: function (G) { if (G.result == "success") { $("#reportstatus").text("成功提交举报，感谢您对dm5的支持！"); if (A > 0) { var I = $("#btnreport" + A); if (typeof (I) != "undefined" && I.length > 0) { var F = parseInt(I.find("span").text()); I.find("span").text(F + 1); I.text(I.text().replace("举报", "已举报")); I.attr("style", "color:#777;margin-right:8px"); I.unbind("click") } var E = $("#lastbtnreport" + A); if (typeof (E) != "undefined" && E.length > 0) { var H = parseInt(E.find("span").text()); E.find("span").text(H + 1); E.text(E.text().replace("举报", "已举报")); E.attr("style", "color:#777;margin-right:8px"); E.unbind("click") } } } else { $("#reportstatus").hide(); $("#postreportimg").attr("src", "image.ashx?action=bar?d=" + new Date()); $("#showreportmessage").text(G.msg); $("#reportform").show() } } }); return false } function reply(D) { var C = getloginstatus(); if (!C || C == "0") { showlogin(); return } if (DM5_ISREPLAYSHOW == false) { DM5_DIAG_DIAG2 = $("#replydialog"); DM5_DIAG_DIAG2.dialog({ width: 620, draggable: false, resizable: false, autoOpen: false, modal: true, title: "参与/回复主题" }); $("#replyform").html("<p style='text-align:center;'>正在加载,请稍候...</p>"); DM5_DIAG_DIAG2.dialog("open"); $(window).scroll(function () { DM5_DIAG_DIAG2.dialog("option", "position", "center") }); $("#replyform").load("/replydialog/", function () { $("#rpcontent").text("RE:" + $("#title" + D).text()); $("#rpusername").text($("#replyuser" + D).text()); $("#tid").val(D); $("#postimg").attr("src", "image.ashx?action=bar?d=" + new Date()) }); DM5_ISREPLAYSHOW = true } else { var B = $("#replyuser" + D).text(); var A = $("#title" + D).text(); $("#rpcontent").text("RE:" + A); $("#rpusername").text(B); $("#tid").val(D); $("#postimg").attr("src", "image.ashx?action=bar?d=" + new Date()); DM5_DIAG_DIAG2.dialog("open") } } function replaypost(G) { var F = getloginstatus(); if (!F || F == "0") { showlogin(); return } var D = $("#replyuser" + G); var E; if (D.length > 0) { E = D.text() } else { D = $("#lastreplyuser" + G); if (D.length > 0) { E = D.text() } } var B = $("#no" + G); var C; if (B.length > 0) { C = B.text() } else { B = $("#lastno" + G); if (B.length > 0) { C = B.text() } } $("#pid").val(G); $("#txt_retitle").val("回复" + C + E + "的帖子\r\n"); $("#txt_recontent").val("回复" + C + E + "的帖子\r\n"); if (typeof (DM5_ISCHAPTER) != "undefined") { var A = $("#loadmore .morepl1"); if (A.length == 0) { A = $("#loadmore .morepl") } if (A.length > 0) { if (A.is(":hidden")) { A.show(); $(window).unbind("scroll") } } } setCaretPosition("txt_recontent") } function setCaretPosition(C) { var B = document.getElementById(C); var A = B.value.length; $("#" + C).focus(); if (B != null) { if (B.createTextRange) { var E = B.createTextRange(); E.move("character", A); E.select() } else { B.setSelectionRange(A, A); var D = document.createEvent("KeyboardEvent"); if (typeof (D.initKeyEvent) != "undefined") { D.initKeyEvent("keypress", true, true, null, false, false, false, false, 0, 32); B.dispatchEvent(D) } D = document.createEvent("KeyboardEvent"); if (typeof (D.initKeyEvent) != "undefined") { D.initKeyEvent("keypress", true, true, null, false, false, false, false, 8, 0); B.dispatchEvent(D) } } } } function validpost(D, C) { var B = { "result": "0" }; var A = 2; if (C) { A = 1 } else { C = "" } $.ajax({ url: "checkpost.ashx?d=" + new Date(), type: "POST", dataType: "json", async: false, data: { type: A, title: C, content: D }, error: function (E) { }, success: function (E) { B = E } }); return B } function position(B, A) { $.ajax({ url: "position.ashx?d=" + new Date(), dataType: "json", data: { pid: B, v: A }, error: function (C) { alert(C) }, success: function (E) { var D; var F; var C; var G; if (A == 1) { D = $("#support_" + B); if (D.length > 0) { F = parseInt(D.find("span").text()); D.find("span").text(F + 1); D.text(D.text().replace("支持", "已支持")); D.attr("style", "color:#777;margin-right:8px"); D.removeAttr("href") } C = $("#lastsupport_" + B); if (C.length > 0) { G = parseInt(C.find("span").text()); C.find("span").text(G + 1); C.text(C.text().replace("支持", "已支持")); C.attr("style", "color:#777;margin-right:8px"); C.removeAttr("href") } } else { D = $("#against_" + B); if (D.length > 0) { F = parseInt(D.find("span").text()); D.find("span").text(F + 1); D.text(D.text().replace("反对", "已反对")); D.attr("style", "color:#777;margin-right:8px"); D.removeAttr("href") } C = $("#lastagainst_" + B); if (C.length > 0) { G = parseInt(C.find("span").text()); C.find("span").text(G + 1); C.text(C.text().replace("反对", "已反对")); C.attr("style", "color:#777;margin-right:8px"); C.removeAttr("href") } } } }) } function valdata() { $("#topic_postbt").attr("disabled", "true"); $("#topic_postbt").val("正在提交"); var A = valtopic(); if (!A) { $("#topic_postbt").removeAttr("disabled"); $("#topic_postbt").val("发表评论") } return A } function valdatare() { $("#post_postbt").attr("disabled", "true"); $("#post_postbt").val("正在提交"); var A = valpost(); if (!A) { $("#post_postbt").removeAttr("disabled"); $("#post_postbt").val("发表评论") } return A } function valtopic() { var G = getloginstatus(); if (!G || G == "0") { showlogin(); return false } var A = $("#txt_title").val(); if (A.length < 3) { ShowDialog("标题字数不能小于3个！"); return false } if (A.length > 30) { ShowDialog("标题字数不能超过30个！"); return false } var F = $("#txt_content").val(); if (F.length < 5) { ShowDialog("内容字数不能小于5个！"); return false } if (F.length < 6 && (F.indexOf("沙发") >= 0 || F.indexOf("沙發") >= 0 || F.indexOf("sf") >= 0 || F.indexOf("shafa") >= 0)) { ShowDialog("建议您发表更有意义的评论！"); return false } if (F.length > 2000) { ShowDialog("字数不能超过2000个！"); return false } var D = $("#cg"); if (D.val() == "0") { ShowDialog("分类必须选择！"); return false } var C = $("#txt_bcode"); if (C.length > 0) { if (C.val() == "") { ShowDialog("验证码必须填写！"); return false } if (!validcode("topicimg", C.val(), "bar")) { ShowDialog("验证码错误！"); return false } } var E = validpost(F, A); if (E.result != "1") { var B = E.msg; ShowDialog(B); return false } return true } function valpost() { var D = getloginstatus(); if (!D || D == "0") { showlogin(); return false } var A = $("#txt_recode"); if (A.length > 0) { if (A.val() == "") { ShowDialog("验证码必须填写！"); return false } if (!validcode("postimg", A.val(), "bar")) { ShowDialog("验证码错误！"); return false } } var C = $("#txt_recontent").val(); if (C.length < 5) { ShowDialog("内容字数不能小于5个！"); return false } if (C.length < 6 && (C.indexOf("沙发") >= 0 || C.indexOf("沙發") >= 0 || C.indexOf("sf") >= 0 || C.indexOf("shafa") >= 0)) { ShowDialog("建议您发表更有意义的评论！"); return false } if (C.length > 2000) { ShowDialog("字数不能超过2000个！"); return false } var B = validpost(C); if (B.result != "1") { ShowDialog(B.msg); return false } return true } function showuser() { var A = getUserinfo(); if (A.Name) { document.write(A.Name) } else { document.write("游客") } } function showtxtwrite(B) { var A = ""; if (DM5_LOGIN_STATUS) { A = '<textarea name="'; A += B; A += '" id="'; A += B; A += '" class="kkx2k" style="width:560px;" value=""></textarea>'; $("#" + B).replaceWith(A) } else { A = '你需要登录后才可以发表新帖 <a href="javascript:showlogin();">登录</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/register/?from='; A += DM5_FROM; A += '">注册</a>'; $("#" + B).html(A) } } function showtxtwrite2(B) { var A = ""; if (DM5_LOGIN_STATUS) { A = '<textarea name="'; A += B; A += '" id="'; A += B; A += '" class="kkx2k" style="width:770px;" value=""></textarea>'; $("#" + B).replaceWith(A) } else { A = ' 你需要登录后才可以回帖 <a href="javascript:showlogin();">登录</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/register/?from='; A += DM5_FROM; A += '">注册</a>'; $("#" + B).html(A) } } function showtxtwrite3(B) { var A = ""; if (DM5_LOGIN_STATUS) { A = '<textarea name="'; A += B; A += '" id="'; A += B; A += '" class="kkx2k" style="width:100%;" value=""></textarea>'; $("#" + B).replaceWith(A) } else { A = ' 你需要登录后才可以回帖 <a href="javascript:showlogin();">登录</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/register/?from='; A += DM5_FROM; A += '">注册</a>'; $("#" + B).html(A) } } function newreply(C) { var B = getloginstatus(); if (!B || B == "0") { showlogin(); return } if (DM5_ISREPLAYSHOW == false) { DM5_DIAG_DIAG2 = $("#replydialog"); DM5_DIAG_DIAG2.dialog({ width: 620, draggable: false, resizable: false, autoOpen: false, modal: true, title: "参与/回复主题" }); $("#replyform").html("<p style='text-align:center;'>正在加载,请稍候...</p>"); DM5_DIAG_DIAG2.dialog("open"); $(window).scroll(function () { DM5_DIAG_DIAG2.dialog("option", "position", "center") }); $("#replyform").load("/replydialog/?t=2", function () { $("#rpcontent").text("RE:" + $("#title" + C).text()); $("#tid").val(C); $("#newpostimg").attr("src", "image.ashx?action=bar?d=" + new Date()) }); DM5_ISREPLAYSHOW = true } else { var A = $("#title" + C).text(); $("#rpcontent").text("RE:" + A); $("#tid").val(C); $("#newpostimg").attr("src", "image.ashx?action=bar?d=" + new Date()); DM5_DIAG_DIAG2.dialog("open") } } function newvaldatare() { $("#newpost_postbt").attr("disabled", "true"); $("#newpost_postbt").val("正在提交"); var A = newvalpost(); if (!A) { $("#newpost_postbt").removeAttr("disabled"); $("#newpost_postbt").val("发表评论") } return A } function newvalpost() { var D = getloginstatus(); if (!D || D == "0") { showlogin(); return false } var A = $("#newtxt_recode"); if (A.length > 0) { if (A.val() == "") { ShowDialog("验证码必须填写！"); return false } if (!validcode("newpostimg", A.val(), "bar")) { ShowDialog("验证码错误！"); return false } } var C = $("#new_txt_recontent").val(); if (C.length < 5) { ShowDialog("内容字数不能小于5个！"); return false } if (C.length < 6 && (C.indexOf("沙发") >= 0 || C.indexOf("沙發") >= 0 || C.indexOf("sf") >= 0 || C.indexOf("shafa") >= 0)) { ShowDialog("建议您发表更有意义的评论！"); return false } if (C.length > 2000) { ShowDialog("字数不能超过2000个！"); return false } var B = validpost(C); if (B.result != "1") { ShowDialog(B.msg); return false } return true };